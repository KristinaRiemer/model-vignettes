---
title: "Prepare Parameter Data for Upload to BETYdb"
author: "Kristina Riemer, University of Arizona"
output: github_document
urlcolor: blue
---

Necessary R libraries. 
```{r}
library(dplyr)
library(stringr)
library(lubridate)
library(tidyr)
library(readxl)
library(udunits2)
```

## Physiological parameters Vmax, Rd, AQY, stomatal slope, and cuticular conductance from the growth chamber

Read in parameters data from [sentinel-detection repository](https://github.com/jessicaguo/sentinel-detection), which should be cloned into the same folder as model-vignettes repo. 
```{r}
all_parameters <- read.csv("../../../sentinel-detection/parameters_pipeline/outputs/parameters_data.csv")
```

Clean up data to have the final columns: 

1. `notes`: records which row in the parameters_data.csv the record came from
2. `local_datetime`: convert date into machine readable format
3. `treatment`: specifies record's treatment using BETYdb treatment names
4. `Vcmax`, `leaf_respiration_rate_m2`, `quantum_efficiency`, `stomatal_slope.g1`, `stomatal_slope.BB`,  `cuticular_cond`: measured values of physiological parameters specified
5. `leafT`: leaf temperature, which is required by BETYdb

First, manage the chamber experiment parameters:
```{r}
upload_parameters_ch <- all_parameters %>% 
  dplyr::mutate(notes = paste("row", row_number(), "in parameters_data.csv")) %>% 
  filter(Genotype == "ME034", 
         Treatment %in% c("31_22_250",
                          "31_31_250",
                          "31_22_450"), 
         trait %in% c("vmax", "Rd", "AQY", "g1M", "g1BB", "g0BB")) %>% 
  mutate(Date = as.POSIXct(as.character(Date), format = "%Y%m%d"), 
         treatment = case_when(Treatment == "31_22_250" ~ "regular night temperature", 
                               Treatment == "31_31_250" ~ "high night temperature", 
                               Treatment == "31_22_450" ~ "high light")) %>% 
  select(-ID, -rep, -SD, -Date.run, -Genotype, -A_Ci, -A_Qin, -Rd, -Treatment) %>% 
  spread(trait, Value) %>% 
  dplyr::rename(local_datetime = Date, 
         Vcmax = vmax, 
         leaf_respiration_rate_m2 = Rd, 
         quantum_efficiency = AQY,
         stomatal_slope.g1 = g1M, 
         stomatal_slope.BB = g1BB,
         cuticular_cond = g0BB) %>% 
  mutate(leafT = 25, 
         n = 9999)
```

Save cleaned parameter as a .csv file in `upload_params_data` folder in `model-vignettes/BioCro/DARPA`. 
```{r}
if(!dir.exists("upload_params_data/")){
  dir.create("upload_params_data")
}

write.csv(upload_parameters_ch, "upload_params_data/phys_parameters_ch.csv", row.names = FALSE)
```

Split dataframe for each parameter type and save each dataframe as a csv. 
```{r}
params <- colnames(upload_parameters_ch)[5:10]
for(param in params){
  removecols <- setdiff(params, param)
  trait_df <- subset(upload_parameters_ch, 
                     select = setdiff(colnames(upload_parameters_ch), removecols))
  trait_df2 <- trait_df[complete.cases(trait_df[,2:ncol(trait_df)]),] # exclude SE from complete.cases
  trait_df3 <- if(param == "stomatal_slope.g1") {
    subset(trait_df2, select = -leafT)
  } else {
      trait_df2
  }
  print(nrow(trait_df3))
  write.csv(trait_df3, paste0("upload_params_data/phys_parameters_ch_", param, ".csv"), row.names = FALSE)
}
```
Upload that new parameter data file using the [Bulk Upload](http://welsch.cyverse.org:8000/bety/bulk_upload/start_upload) in Welsch BETYdb. The following additional data, which applies across all the parameters, will have to be entered

- site: Donald Danforth Plant Science Center Growth Chamber
- species: Setaria viridis
- access_level: Internal & Collaborators
- cultivar: ME-034




## Physiological parameters Vmax, Rd, AQY, stomatal slope, and cuticular conductance from the greenhouse

Clean up data to have the final columns: 

1. `notes`: records which row in the Google Sheet the record came from
2. `local_datetime`: convert date into machine readable format
3. `treatment`: specifies record's treatment using BETYdb treatment names
4. `Vcmax`, `leaf_respiration_rate_m2`, `quantum_efficiency`, `stomatal_slope.g1`, `stomatal_slope.BB`, `cuticular_cond`: measured values of physiological parameters specified
5. `leafT`: leaf temperature, which is required by BETYdb

```{r}
upload_parameters_gr <- all_parameters %>% 
  dplyr::mutate(notes = paste("row", row_number(), "in parameters_data.csv")) %>% 
  filter(Genotype == "ME034", 
         Treatment == "greenhouse", 
         trait %in% c("vmax", "Rd", "AQY", "g1M", "g1BB", "g0BB")) %>% 
  mutate(Date = as.POSIXct(as.character(Date), format = "%Y%m%d"), 
         treatment = case_when(Treatment == "greenhouse" ~ "greenhouse")) %>% 
  select(-ID, -rep, -SD, -Date.run, -Genotype, -A_Ci, -A_Qin, -Rd, -Treatment) %>% 
  spread(trait, Value) %>% 
  dplyr::rename(local_datetime = Date, 
         Vcmax = vmax, 
         leaf_respiration_rate_m2 = Rd, 
         quantum_efficiency = AQY,
         stomatal_slope.g1 = g1M, 
         stomatal_slope.BB = g1BB,
         cuticular_cond = g0BB) %>% 
  mutate(leafT = 25, 
         n = 9999)
```

Split dataframe for each parameter type and save each dataframe as a csv. 
```{r}
params <- colnames(upload_parameters_gr)[5:10]
for(param in params){
  removecols <- setdiff(params, param)
  trait_df <- subset(upload_parameters_gr, 
                     select = setdiff(colnames(upload_parameters_gr), removecols))
  trait_df2 <- trait_df[complete.cases(trait_df[,2:ncol(trait_df)]),] # exclude SE from complete.cases
  trait_df3 <- if(param == "stomatal_slope.g1") {
    subset(trait_df2, select = -leafT)
  } else {
      trait_df2
    }
  write.csv(trait_df3, paste0("upload_params_data/phys_parameters_gr_", param, ".csv"), row.names = FALSE)
}
```

Upload that new parameter data file using the [Bulk Upload](http://welsch.cyverse.org:8000/bety/bulk_upload/start_upload) in Welsch BETYdb. The following additional data, which applies across all the parameters, will have to be entered

- site: Donald Danforth Plant Science Center Greenhouse
- species: Setaria viridis
- access_level: Internal & Collaborators
- cultivar: ME-034


## Specific leaf area

These SLA values are only for the high night temperature treatment from experiment 3rd_Biomass_ME034_GA_Exp. Read in, clean up, and combine leaf biomass measurements with corresponding leaf area measurements. 

These are the final columns:

1. `local_datetime`: convert date into machine readable format
2. `treatment`: specifies record's treatment using BETYdb treatment names
3. `SLA`: measured values of specific leaf area
```{r}
data_path <- "../../../model-vignettes-data/manual-measurements-Darpa_setaria_chambers_experiments.xlsx"
sheets_names <- excel_sheets(data_path)

leaf_biomass_hightemp <- read_excel(data_path, sheets_names[11]) %>% 
  rename(temperature = 6, 
         leaf_dry_biomass_mg = 19) %>% 
  filter(temperature == "31.0", 
         `light_intensity(umol/m2/s)` == "250.0",
         !is.na(leaf_dry_biomass_mg), 
         treatment == "control") %>% 
  mutate(leaf_dry_biomass_mg == as.numeric(leaf_dry_biomass_mg))

leaf_area_hightemp <- read_excel(data_path, sheets_names[2]) %>% 
  rename(leaf_area_cm2 = 8) %>% 
  filter(experiment == "3rd_Biomass_ME034_GA", 
         treatment == "control")

sla_hightemp <- left_join(leaf_biomass_hightemp, leaf_area_hightemp, by = "plantID") %>% 
  mutate(sla_initial_units = leaf_area_cm2 / leaf_dry_biomass_mg, 
         dry_biomass_kg = ud.convert(leaf_dry_biomass_mg, "mg", "kg"), 
         area_m2 = ud.convert(leaf_area_cm2, "cm2", "m2"), 
         SLA = area_m2 / dry_biomass_kg) %>% 
  mutate(local_datetime = as.Date(`biomas harvested`), 
         treatment = "high night temperature") %>% 
  select(local_datetime, treatment, SLA) %>% 
  mutate(statname = '')

leaf_biomass_control <- read_excel(data_path, sheets_names[7]) %>% 
  rename(temperature = 6, 
         leaf_dry_biomass_mg = 19, 
         plantID = 1) %>% 
  filter(temperature == "31/22", 
         genotype == "ME034V-1", 
         !is.na(leaf_dry_biomass_mg))

leaf_area_control <- read_excel(data_path, sheets_names[2]) %>% 
  rename(leaf_area_cm2 = 8) %>% 
  filter(experiment == "5th_Biomass_A10&ME034_cycling_temp")

sla_control <- left_join(leaf_biomass_control, leaf_area_control, by = "plantID") %>% 
  filter(!is.na(leaf_area_cm2)) %>% 
  mutate(sla_initial_units = leaf_area_cm2 / leaf_dry_biomass_mg, 
         dry_biomass_kg = ud.convert(leaf_dry_biomass_mg, "mg", "kg"), 
         area_m2 = ud.convert(leaf_area_cm2, "cm2", "m2"), 
         SLA = area_m2 / dry_biomass_kg) %>% 
    mutate(local_datetime = as.Date(`biomass harvested`), 
         treatment = "high light") %>% 
  select(local_datetime, treatment, SLA) %>% 
  mutate(statname = '')

sla <- bind_rows(sla_hightemp, sla_control)
```

Save SLA data as a .csv. 
```{r}
write.csv(sla, file = "upload_params_data/sla.csv", row.names = FALSE)
```

Upload values to Welsch BETYdb using the same method as for physiological parameters. 