---
title: "Prepare Parameter Data for Upload to BETYdb"
author: "Kristina Riemer, University of Arizona"
output: github_document
urlcolor: blue
---

Necessary R libraries. 
```{r}
library(dplyr)
library(stringr)
library(lubridate)
library(tidyr)
library(readxl)
library(udunits2)
```

## Physiological parameters Vmax, Rd, AQY, stomatal slope, and cuticular conductance f

Read in parameters data from [sentinel-detection repository](https://github.com/jessicaguo/sentinel-detection), which should be cloned into the same folder as model-vignettes repo. 
```{r}
all_parameters <- read.csv("../../../sentinel-detection/parameters_pipeline/outputs/parameters_data.csv")
```

Read in previous phys_parameters.csv. 
```{r}
phys <- read.csv("upload_params_data/phys_parameters.csv")
```

Clean up data to have the final columns: 

1. `citation_author`, `citation_year`, and `citation_title`: indicate the source of the data using author, year, and title from BETYdb
2. `species`: Setaria viridis, `cultivar`: ME-034
3. `site`: one of three sites at Donald Danforth Plant Science Center, either Growth Chamber, Greenhouse, or Outdoor, using BETYdb site names
4. `treatment`: specifies record's treatment using BETYdb treatment names
5. `local_datetime`: convert date into machine readable format
6.  `Vcmax`, `leaf_respiration_rate_m2`, `quantum_efficiency`, `stomatal_slope.BB`,  `cuticular_cond`: estimated mean of physiological parameters from parameters_data.csv
7. `leafT`: leaf temperature, which is required by BETYdb
8. `n`: sample size, always set to 1
9. `SE`: estimated standard error of physiological parameters from parameters_data.csv
10. `notes`: records which row in the parameters_data.csv the record came from
11. `access_level`: Internal & Collaborators

First, manage the chamber experiment parameters:
```{r}
upload_parameters <- all_parameters %>% 
  dplyr::mutate(notes = paste("row", row_number(), "in parameters_data.csv")) %>% 
  filter(Genotype == "ME034", 
         trait %in% c("vmax", "Rd", "AQY", "g1BB", "g0BB")) %>% 
  mutate(Date = as.POSIXct(as.character(Date), format = "%Y%m%d"), 
         treatment = case_when(Treatment == "31_22_250" ~ "regular night temperature", 
                               Treatment == "31_31_250" ~ "high night temperature", 
                               Treatment == "31_22_450" ~ "high light",
                               Treatment == "greenhouse" ~ "greenhouse",
                               Treatment == "outdoor_5cm" ~ "outdoor 5 cm density",
                               Treatment == "outdoor_JollyG" ~ "outdoor 5 cm density"),
         site = case_when(Treatment == "31_22_250" ~ "Donald Danforth Plant Science Center Growth Chamber", 
                               Treatment == "31_31_250" ~ "Donald Danforth Plant Science Center Growth Chamber", 
                               Treatment == "31_22_450" ~ "Donald Danforth Plant Science Center Growth Chamber",
                               Treatment == "greenhouse" ~ "Donald Danforth Plant Science Center Greenhouse",
                               Treatment == "outdoor_5cm" ~ "Donald Danforth Plant Science Center Outdoor",
                               Treatment == "outdoor_JollyG" ~ "Donald Danforth Plant Science Center Outdoor")) %>% 
  select(-ID, -rep, -SD, -Date.run, -Genotype, -A_Ci, -A_Qin, -Rd, -Treatment) %>% 
  spread(trait, Value) %>% 
  dplyr::rename(local_datetime = Date, 
         Vcmax = vmax, 
         leaf_respiration_rate_m2 = Rd, 
         quantum_efficiency = AQY,
         stomatal_slope.BB = g1BB,
         cuticular_cond = g0BB) %>% 
  mutate(leafT = 25, 
         n = 1,
         species = "Setaria viridis",
         cultivar = "ME-034",
         citation_author = "Zhang, Gehan, LeBauer, Riemer, Tarin, Vargas",
         citation_year = "2018", 
         citation_title = "Unpublished DARPA experimental data",
         access_level = "Internal & Collaborators"
         ) %>%
  select(citation_author, citation_year, citation_title, 
         species, cultivar, site, treatment, local_datetime,
         Vcmax, leaf_respiration_rate_m2, quantum_efficiency, stomatal_slope.BB, cuticular_cond,
         leafT, n, SE, notes, access_level)
```

Save cleaned parameter as a .csv file in `upload_params_data` folder in `model-vignettes/BioCro/DARPA`. 
```{r}
if(!dir.exists("upload_params_data/")){
  dir.create("upload_params_data")
}

write.csv(upload_parameters_ch, "upload_params_data/phys_parameters.csv", row.names = FALSE)
```


Upload that new parameter data file using the API. 
```{bash}
curl -X POST --data-binary @upload_params_data/phys_parameters welsch.cyverse.org:8787/bety/api/v1/traits.csv?key=<fOME9Ga8VMGmieLfuFD2QDgvFbWHqMUBthXEYkjz> -H "Content-Type: text/csv"
```


## Specific leaf area

These SLA values are only for the high night temperature treatment from experiment 3rd_Biomass_ME034_GA_Exp. Read in, clean up, and combine leaf biomass measurements with corresponding leaf area measurements. 

These are the final columns:

1. `local_datetime`: convert date into machine readable format
2. `treatment`: specifies record's treatment using BETYdb treatment names
3. `SLA`: measured values of specific leaf area
```{r}
data_path <- "../../../model-vignettes-data/manual-measurements-Darpa_setaria_chambers_experiments.xlsx"
sheets_names <- excel_sheets(data_path)

leaf_biomass_hightemp <- read_excel(data_path, sheets_names[11]) %>% 
  rename(temperature = 6, 
         leaf_dry_biomass_mg = 19) %>% 
  filter(temperature == "31.0", 
         `light_intensity(umol/m2/s)` == "250.0",
         !is.na(leaf_dry_biomass_mg), 
         treatment == "control") %>% 
  mutate(leaf_dry_biomass_mg == as.numeric(leaf_dry_biomass_mg))

leaf_area_hightemp <- read_excel(data_path, sheets_names[2]) %>% 
  rename(leaf_area_cm2 = 8) %>% 
  filter(experiment == "3rd_Biomass_ME034_GA", 
         treatment == "control")

sla_hightemp <- left_join(leaf_biomass_hightemp, leaf_area_hightemp, by = "plantID") %>% 
  mutate(sla_initial_units = leaf_area_cm2 / leaf_dry_biomass_mg, 
         dry_biomass_kg = ud.convert(leaf_dry_biomass_mg, "mg", "kg"), 
         area_m2 = ud.convert(leaf_area_cm2, "cm2", "m2"), 
         SLA = area_m2 / dry_biomass_kg) %>% 
  mutate(local_datetime = as.Date(`biomas harvested`), 
         treatment = "high night temperature") %>% 
  select(local_datetime, treatment, SLA) %>% 
  mutate(statname = '')

leaf_biomass_control <- read_excel(data_path, sheets_names[7]) %>% 
  rename(temperature = 6, 
         leaf_dry_biomass_mg = 19, 
         plantID = 1) %>% 
  filter(temperature == "31/22", 
         genotype == "ME034V-1", 
         !is.na(leaf_dry_biomass_mg))

leaf_area_control <- read_excel(data_path, sheets_names[2]) %>% 
  rename(leaf_area_cm2 = 8) %>% 
  filter(experiment == "5th_Biomass_A10&ME034_cycling_temp")

sla_control <- left_join(leaf_biomass_control, leaf_area_control, by = "plantID") %>% 
  filter(!is.na(leaf_area_cm2)) %>% 
  mutate(sla_initial_units = leaf_area_cm2 / leaf_dry_biomass_mg, 
         dry_biomass_kg = ud.convert(leaf_dry_biomass_mg, "mg", "kg"), 
         area_m2 = ud.convert(leaf_area_cm2, "cm2", "m2"), 
         SLA = area_m2 / dry_biomass_kg) %>% 
    mutate(local_datetime = as.Date(`biomass harvested`), 
         treatment = "high light") %>% 
  select(local_datetime, treatment, SLA) %>% 
  mutate(statname = '')

sla <- bind_rows(sla_hightemp, sla_control)
```

Save SLA data as a .csv. 
```{r}
write.csv(sla, file = "upload_params_data/sla.csv", row.names = FALSE)
```

Upload values to Welsch BETYdb using the same method as for physiological parameters. 