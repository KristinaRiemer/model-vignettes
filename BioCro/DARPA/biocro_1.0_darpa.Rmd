---
title: "Using BioCro 1.0 on Setaria Data"
author: "Author: Kristina Riemer"
output: github_document
urlcolor: blue
---

### Switching between BioCro versions locally

Download repos for [BioCro 0.95](https://github.com/ebimodeling/biocro) and [BioCro 1.0](https://github.com/ebimodeling/biocro/tree/new-framework), and place unzipped folders into this repo in `BioCro/DARPA`. Use the code below to switch between these two versions when needs. 

BioCro 0.95: 
```{r, eval=FALSE}
install.packages('biocro_0.95/biocro-master', repos = NULL, type = 'SOURCE')
```

BioCro 1.0: 
```{r, message=FALSE}
install.packages('biocro_1.00/biocro-new-framework', repos = NULL, type = 'SOURCE')
```

Check version: 
```{r, message=FALSE}
library(BioCro)
sessionInfo()
```

### Running new version on set parameters

#### Read in data

```{r}
library(dplyr)
OpBioGro_weather <- read.csv("biocro_opt_darpa_files/OpBioGro_weather.csv") %>% 
  rename(solar = solarR, temp = DailyTemp.C, rh = RH, windspeed = WindSpeed)
OpBioGro_biomass <- read.csv("biocro_opt_darpa_files/OpBioGro_biomass.csv")
```

#### Set up parameters

The following code uses BioCro 1.0. 

Set up the parameters for *Setaria* with these two lists, `setaria_initial_state` and `setaria_parameters`. This uses parameter values from optimizing the older version of BioCro. 
```{r, message=FALSE}
setaria_initial_state <- with(list(), {
  datalines =
    "symbol value
    
    # BioCro arguments
    Rhizome 0.001
    Leaf 0.001
    Stem 0.001
    Root 0.001
    
    Grain 0
    soil_water_content 0.32
    LeafN 2
    TTc 0
    LeafLitter 0
    RootLitter 0
    RhizomeLitter 0
    StemLitter 0
    leaf_senescence_index 0
    stem_senescence_index 0
    root_senescence_index 0
    rhizome_senescence_index 0"
  
  data_frame = utils::read.table(textConnection(datalines), header=TRUE)
  values = as.list(data_frame$value)
  names(values) = data_frame$symbol
  values
})

setaria_parameters <- with(list(), {
  datalines =
    "symbol value
    acceleration_from_gravity 9.8
    
    # config$location$latitude
    lat 38.67459
    
    soil_clod_size 0.04
    soil_reflectance 0.2
    soil_transmission 0.01
    specific_heat 1010
    stefan_boltzman 5.67e-8
    iSp 1.7
    Sp_thermal_time_decay 0
    
    # canopyControl
    nlayers 10
    kd 0.1
    chil 1
    heightf 3
    leafwidth 0.04
    et_equation 0
    
    growth_respiration_fraction 0 # is this mResp?
    
    # seneControl
    seneLeaf 3000
    seneStem 3500
    seneRoot 4000
    seneRhizome 4000
    
    tbase 0
    
    # photoParms
    vmax1 29.7409235442261
    alpha1 0.04
    kparm 0.7
    theta 0.83
    beta 0.93
    Rd 1.33025819997024
    Catm 400
    b0 0.0138148692577794
    b1 5.7057446269736
    water_stress_approach 1
    upperT 37.5
    lowerT 3

    # soil control (only missing FieldC & WiltP)
    phi1 0.01
    phi2 10
    soil_depth 1
    soil_type_indicator 6
    soilLayers 1
    wsFun 0
    scsf 1
    transpRes 5000000
    leafPotTh -800
    hydrDist 0
    rfl 0.2
    rsec 0.2
    rsdf 0.44
    
    # optimalParms
    tp1 150
    tp2 300
    tp3 450
    tp4 600
    tp5 750
    tp6 900
    kStem1 0.312482562
    kLeaf1 0.350204711
    kRoot1 0.337312727
    kRhizome1 0
    kGrain1 0
    kStem2 0.28215246
    kLeaf2 0.385131018
    kRoot2 0.332716522
    kRhizome2 0
    kGrain2 0
    kStem3 0.449611092
    kLeaf3 0.549167954
    kRoot3 0.001220954
    kRhizome3 0
    kGrain3 0
    kStem4 0.450730685
    kLeaf4 0.38210712
    kRoot4 0.167162195
    kRhizome4 0
    kGrain4 0
    kStem5 0.687613079
    kLeaf5 0.197814203
    kRoot5 0.114572719
    kRhizome5 0
    kGrain5 0
    kStem6 0.758825523
    kLeaf6 0.01127437
    kRoot6 0.143217809
    kRhizome6 0
    kGrain6 0.086682298
    
    LeafN_0 2
    kln 0.5
    vmax_n_intercept 0
    alphab1 0
    kpLN 0.2
    lnb0 -5
    lnb1 18
    lnfun 0
    nileafn 85
    nkln 0.5
    nvmaxb1 0.6938
    nvmaxb0 -16.25
    nalphab1 0.000488
    nalphab0 0.02367
    nRdb1 0.1247
    nRdb0 -4.5917
    nkpLN 0.17
    nlnb0 -5
    nlnb1 18
    timestep 1
    mrc1 0.02
    mrc2 0.03
    leaf_reflectance 0.2
    leaf_transmittance 0.2"
  
  data_frame = utils::read.table(textConnection(datalines), header=TRUE)
  values = as.list(data_frame$value)
  names(values) = data_frame$symbol
  values
})
```

Create the modules, which are currently developed for *Sorghum*. 
```{r}
sorghum_modules <- list(canopy_module_name='c4_canopy',
                       soil_module_name='one_layer_soil_profile',
                       growth_module_name='partitioning_growth',
                       senescence_module_name='thermal_time_senescence',
                       leaf_water_stress_module_name='leaf_water_stress_exponential',
                       stomata_water_stress_module_name='stomata_water_stress_linear')
```

#### Run model 

Use these three inputs, along with a weather file included with the package, to generate biomass values for **Setaria**. 

```{r}
setaria_result <- Gro(setaria_initial_state, 
                      setaria_parameters, 
                      get_growing_season_climate(OpBioGro_weather), 
                      sorghum_modules)
```

#### Plot results with data

We are plotting the estimated biomass values from BioCro with the measured values that were used to estimate the parameters, in order to compare them. 

```{r, message=FALSE}
library(ggplot2)
plot_biomass <- function(biomass_estimates){
  est_plot <- biomass_estimates %>% 
    select(TTc, Stem, Leaf, Root, Rhizome, Grain) %>% 
    tidyr::pivot_longer(Stem:Grain) %>% 
    rename(ThermalT = TTc)
  data_plot <- OpBioGro_biomass %>% 
    select(-LAI) %>% 
    tidyr::pivot_longer(Stem:Grain)
  biomass_plot <- ggplot() +
    geom_point(data_plot, mapping = aes(x = ThermalT, y = value, color = name)) +
    geom_line(est_plot, mapping = aes(x = ThermalT, y = value, color = name)) +
  xlim(c(0, 1800)) +
  labs(x = "Thermal Time", y = "Biomass (Ma/ha)", color = "Plant Part") +
  theme_classic() +
  facet_wrap(~name)
  print(biomass_plot)
}
plot_biomass(setaria_result)
```

### Optimizing `Gro` for *Setaria* parameters

#### Set up and test objective function

k_params are part of setaria_parameters (`setaria_parameters[53:82]`). kRhizome6 has to be zero?

What's below isn't actually optimizing, as each iteration has the same values. 
```{r, eval=FALSE}
nonk_params <- setaria_parameters[-c(53:80, 82)]
opfn <- function(k_params){
  k_params <- with(list(), {
  datalines =
    "symbol value
    kStem1 0.312482562
    kLeaf1 0.350204711
    kRoot1 0.337312727
    kRhizome1 0
    kGrain1 0
    kStem2 0.28215246
    kLeaf2 0.385131018
    kRoot2 0.332716522
    kRhizome2 0
    kGrain2 0
    kStem3 0.449611092
    kLeaf3 0.549167954
    kRoot3 0.001220954
    kRhizome3 0
    kGrain3 0
    kStem4 0.450730685
    kLeaf4 0.38210712
    kRoot4 0.167162195
    kRhizome4 0
    kGrain4 0
    kStem5 0.687613079
    kLeaf5 0.197814203
    kRoot5 0.114572719
    kRhizome5 0
    kGrain5 0
    kStem6 0.758825523
    kLeaf6 0.01127437
    kRoot6 0.143217809
    kGrain6 0.086682298"
  
  data_frame = utils::read.table(textConnection(datalines), header=TRUE)
  values = as.list(data_frame$value)
  names(values) = data_frame$symbol
  values
})
  all_params <- c(nonk_params, k_params)
  #print(all_params)
  t <- Gro(setaria_initial_state,
           all_params,
           get_growing_season_climate(OpBioGro_weather),
           sorghum_modules)
  #plot_biomass(t)
  tt <- t %>% 
    select(TTc, Stem, Leaf, Root, Rhizome, Grain) %>% 
    rename(ThermalT = TTc)
  ttt <- tt %>% 
    filter(round(tt$ThermalT) %in% round(OpBioGro_biomass$ThermalT))
  bio_ests <- select(ttt, -ThermalT)
  bio_meas <- select(OpBioGro_biomass, -ThermalT, -LAI)
  diff <- abs(bio_ests - bio_meas)
  return(sum(diff))
}

# setaria_k_params <- setaria_parameters[c(53:80, 82)]
# for(i in 1:length(setaria_k_params)){
#   setaria_k_params[[i]] <- 0.2
# }
# opfn(setaria_k_params)

library(DEoptim)
opt_results <- DEoptim(fn = opfn, lower = rep(0, 29), upper = rep(1, 29), control = DEoptim.control(itermax = 2))
```

```{r}
optimal_k_params <- as.list(opt_results$optim$bestmem)
names(optimal_k_params) <- names(setaria_parameters[c(53:80, 82)])
optimal_params <- c(nonk_params, optimal_k_params)

results_test <- Gro(setaria_initial_state, 
                    optimal_params,
                    get_growing_season_climate(OpBioGro_weather), 
                    sorghum_modules)

plot_biomass(results_test)
```


