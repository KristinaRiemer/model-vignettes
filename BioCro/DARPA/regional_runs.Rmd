---
title: "How to Do Regional Runs on DARPA Data Using BioCro Model"
author: "Author: Kristina Riemer"
output: github_document
urlcolor: blue
---

## Read in libraries

```{r}
library(ncdf4)
library(PEcAn.all)
library(PEcAn.BIOCRO)
library(dplyr)
library(ggplot2)
library(maps)
library(rgdal)
library(maptools)
library(gganimate)
```

## Read in input files

The config file here is based on [the default *Setaria* file](https://github.com/PecanProject/pecan/blob/ac5aef2e755a8961591196428753eb184fb4c6cb/models/biocro/inst/extdata/defaults/setaria.xml) used for PEcAn. This one was generated from a run on the Sentinel project data. 
```{r}
config <- read.biocro.config("regional_runs_inputs/config.xml")
```

A weather data file, such as that read in below, is required to run BioCro. The weather data comes from [the North American Regional Reanalysis (NARR)](https://www.esrl.noaa.gov/psd/data/gridded/data.narr.html) global gridded dataset provided by NOAA. We are using a subset of NARR in the eastern part of Illinois, near Chapaign. 

We also read in a soil file, which is not necessary but is useful. These data are from [the harmonized world soil database](http://www.fao.org/soils-portal/soil-survey/soil-maps-and-databases/harmonized-world-soil-database-v12/en/). 
```{r}

soil_nc <- nc_open("regional_runs_inputs/hwsd.nc")
```



## Run BioCro on each location

The BioCro model is then run on weather and soil data for each of the locations, using *Setaria* input data. This produces hourly, daily, and yearly estimates for biomass, transpiration, etc. for the time range we specified in the config file. We are using only the daily values. 
```{r}
dir.create("regional_runs_inputs/results_by_location/")
biocro_results <- c()
for(point in 1:nrow(latlon)){
  biocro_met_path <- paste0("regional_runs_inputs/biocro_met_by_location/biocromet-", 
                            latlon$lat[point], "-", latlon$lon[point])
  biocro_results_all <- run.biocro(latlon$lat[point], latlon$lon[point],
                               metpath = biocro_met_path,
                               soil.nc = soil_nc,
                               config = config)
  biocro_results_daily <- biocro_results_all$daily
  write.csv(biocro_results_daily, paste0("regional_runs_inputs/results_by_location/daily-", 
                                         latlon$lat[point], "-", latlon$lon[point], ".csv"))
  biocro_results_daily$lat <- latlon$lat[point]
  biocro_results_daily$lon <- latlon$lon[point]
  biocro_results <- rbind(biocro_results, biocro_results_daily)
  print(point)
}
write.csv(biocro_results, "regional_runs_inputs/all_biocro_results.csv")
```

## Plot estimated biomass

The results for total biomass (the sum of stem, leaf, grain, rhizome, and root biomasses) are then visualized. 
```{r}
biocro_results <- read.csv("regional_runs_inputs/all_biocro_results.csv")
biocro_results <- biocro_results %>% 
  mutate(date = as.Date(doy, "2009-12-31"), 
         latlon = paste0(lat, lon), 
         total_biomass = Stem + Leaf + Root + Rhizome + Grain)

ggplot(biocro_results, aes(x = date, y = total_biomass, group = latlon, color = latlon)) +
  geom_line() +
  theme(legend.position = "none")
```

This map shows where the locations are in the two countries


This map shows the locations closer up with the nearby ecoregions plotted in various colors. 
```{r}
if (!file.exists("regional_runs_inputs/ecoregions_chiruss.csv")) {
  ecoregions <- readOGR(file.path("regional_runs_inputs", 
                                                "WWF_ecoregions", "official", 
                                                "wwf_terr_ecos.shp"))
  ecoregions@data$id <- rownames(ecoregions@data)
  ecoregions_points <- broom::tidy(ecoregions)
  ecoregions_df <- plyr::join(ecoregions_points, ecoregions@data, by = "id")
  ecoregions_df_chiruss <- ecoregions_df %>% 
   filter(lat > 20 & lat < 80,
          long > 60 & long < 130)
  write.csv(ecoregions_df, "regional_runs_inputs/ecoregions_chiruss.csv")
}
ecoregions_df_chiruss <- read.csv("regional_runs_inputs/ecoregions_chiruss.csv")

ecoregions_background <- map_data("world") %>% 
  filter(region == "China" | region == "Russia") 

ggplot() +
  geom_polygon(data = ecoregions_df_chiruss, aes(long, lat, group = group, fill = ECO_NAME)) +
  geom_polygon(data = ecoregions_background, aes(x = long, y = lat, group = group), fill = NA, color = "black") +
  geom_raster(data = biocro_results, aes(x = lon, y = lat), fill = "red") +
  coord_cartesian(xlim = c(mean(biocro_results$lon) - 20, mean(biocro_results$lon) + 20), 
                  ylim = c(min(biocro_results$lat) - 5, max(biocro_results$lat) + 5)) +
  theme(legend.position = "none")
```

The final map plots estimated biomass values for the `r length(unique(biocro_results$latlon))` locations on this zoomed in map of east Asia, running through each day's values. 

```{r}
gif_background <- map_data("world") %>% 
  filter(region == "China" | region == "Russia")

colfunc <- colorRampPalette(c("yellow", "darkgreen"))
biomass_animation <- ggplot() +
  geom_polygon(data = gif_background, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = biocro_results, aes(x = lon, y = lat, fill = total_biomass)) +
    coord_cartesian(xlim = c(mean(biocro_results$lon) - 20, mean(biocro_results$lon) + 20), 
                  ylim = c(min(biocro_results$lat) - 5, max(biocro_results$lat) + 5)) +
  scale_fill_gradientn(colors = colfunc(10)) +
  transition_manual(doy) +
  ggtitle('Day: {current_frame}')

animate(biomass_animation, fps = 100)
anim_save("biomass_animation_chiruss.gif", animation = biomass_animation, 
          path = "regional_runs_inputs/", fps = 100)
```
