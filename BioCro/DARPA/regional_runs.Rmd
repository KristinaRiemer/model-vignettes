---
title: "How to Do Regional Runs on DARPA Data Using BioCro Model"
author: "Author: Kristina Riemer"
output: github_document
urlcolor: blue
---

## Read in libraries

```{r}
library(PEcAn.BIOCRO)
library(ncdf4)
library(PEcAn.all)
library(dplyr)
library(ggplot2)
library(gganimate)
```

# High Light Treatment Regional Runs

## Read in input files

The config file here comes from [the high light treatment BioCro run](https://github.com/az-digitalag/model-vignettes/blob/master/BioCro/DARPA/high_light.Rmd), specifically the config file in the SA-median run folder. 

```{r}
config <- read.biocro.config("regional_runs_inputs/config.xml")
```

We also read in a soil file, which is not necessary but is useful. These data are from [the harmonized world soil database](http://www.fao.org/soils-portal/soil-survey/soil-maps-and-databases/harmonized-world-soil-database-v12/en/). 

```{r}
soil_nc <- nc_open("regional_runs_inputs/hwsd.nc")
```

## Run BioCro on each location

The BioCro model is then run for each location of interest, using the config file, soil data, and weather data. The locations are determined and indexed from the weather data subset, which are then used to read in the relevant weather csv for the location of interest. 

 The weather data comes from [the CRUNCEP](https://rda.ucar.edu/datasets/ds314.3/) global gridded dataset provided by NCAR. The original NetCDF file has been subsetted according to [the weather subset vignette](https://github.com/az-digitalag/model-vignettes/blob/master/BioCro/DARPA/regional_runs_inputs/subset_weather.Rmd) and converted to the correct csv format required by BioCro according to [the convert weather vignette](https://github.com/az-digitalag/model-vignettes/blob/master/BioCro/DARPA/regional_runs_inputs/convert_weather_chiruss.Rmd). This data is specifically for an extended latitudinal range covering China and Russia. 

The results from running BioCro for each location produces hourly, daily, and yearly estimates for biomass, transpiration, etc. for the time range we specified in the config file. We are using only the daily values, combining them for all locations. 

```{r}
met_stlew <- nc_open("regional_runs_inputs/weather_subsets/stlew.nc")
latlon <- expand.grid(lat = ncvar_get(met_stlew, "latitude"), 
                      lon = ncvar_get(met_stlew, "longitude"))

dir.create("regional_runs_inputs/results")
dir.create("regional_runs_inputs/results/high_light_stlew")

regional_run_results <- c()
for(point in 1:nrow(latlon)){
  biocro_met_path <- paste0("regional_runs_inputs/biocro_met_stlew/stlew-", 
                            latlon$lat[point], "-", latlon$lon[point])
  regional_run_result <- run.biocro(latlon$lat[point], latlon$lon[point],
                               metpath = biocro_met_path,
                               soil.nc = soil_nc,
                               config = config)
  regional_run_result_daily <- regional_run_result$daily
  write.csv(regional_run_result_daily, paste0("regional_runs_inputs/results/high_light_stlew/daily-", 
                                         latlon$lat[point], "-", latlon$lon[point], ".csv"))
  regional_run_result_daily$lat <- latlon$lat[point]
  regional_run_result_daily$lon <- latlon$lon[point]
  regional_run_results <- rbind(regional_run_results, regional_run_result_daily)
  print(point)
}

write.csv(regional_run_results, 
          "regional_runs_inputs/results/high_light_stlew_results.csv")
```

## Plot estimated biomass

The results for total biomass (the sum of stem, leaf, grain, rhizome, and root biomasses) for each location across the year of 2010 are visualized. 

```{r}
regional_run_results <- read.csv("regional_runs_inputs/results/high_light_stlew_results.csv")
regional_run_results <- regional_run_results %>% 
  mutate(date = as.Date(doy, "2009-12-31"), 
         latlon = paste0(lat, lon), 
         total_biomass = as.numeric(Stem + Leaf + Root + Rhizome + Grain))

ggplot(regional_run_results, aes(x = date, y = total_biomass, group = latlon, color = latlon)) +
  geom_line() +
  theme(legend.position = "none")
```

Biomass estimates across space for two days of the year, one in the summer and one in the winter, are plotted. 

```{r}
overall_map <- map_data("world") %>% 
  filter(region == "USA" & is.na(subregion))

summer_day_plot <- ggplot() +
  geom_polygon(data = overall_map, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = filter(regional_run_results, doy == 200), aes(x = lon, y = lat, fill = total_biomass)) +
  coord_quickmap() +
  ggtitle("Day 200")

winter_day_plot <- ggplot() +
  geom_polygon(data = overall_map, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = filter(regional_run_results, doy == 350), aes(x = lon, y = lat, fill = total_biomass)) +
  coord_quickmap() +
  ggtitle("Day 350")

cowplot::plot_grid(summer_day_plot, winter_day_plot, nrow = 1)
```

This map shows the locations closer up with the nearby ecoregions plotted in various colors for day 200. 

```{r}
# ecoregions_df_chiruss <- read.csv("regional_runs_inputs/ecoregions/eocregions_chiruss.csv")
# 
# ecoregions_background <- map_data("world") %>% 
#   filter(region == "China" | region == "Russia") 
# 
# ggplot() +
#   geom_polygon(data = ecoregions_df_chiruss, aes(long, lat, group = group, col = ECO_NAME)) +
#   geom_polygon(data = ecoregions_background, aes(x = long, y = lat, group = group), fill = NA, color = "black") +
#   theme(legend.position = "none") +
#   geom_raster(data = filter(regional_run_results, doy == 200), aes(x = lon, y = lat, fill = total_biomass)) +
#   coord_cartesian(xlim = c(mean(regional_run_results$lon) - 20, mean(regional_run_results$lon) + 20),
#                   ylim = c(min(regional_run_results$lat) - 5, max(regional_run_results$lat) + 5)) +
#   theme(legend.position = "none")
```

The final map plots estimated biomass values for the `r length(unique(regional_run_results$latlon))` locations on this zoomed in map of east Asia, running through each day's values. 

```{r}
gif_background <- map_data("state")
city_coords <- data.frame(name = "St. Louis", lon = -90.199402, lat = 38.627003)

biomass_animation <- ggplot() +
  geom_polygon(data = gif_background, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = regional_run_results, aes(x = lon, y = lat, fill = total_biomass)) +
  geom_point(data = city_coords, aes(x = lon, y = lat)) +
  scale_fill_gradient2(low = "yellow", mid = "yellowgreen", high = "darkgreen", 
                       midpoint = 10, 
                       breaks = seq(-100, 100, 4), 
                       limits = c(0, 20)) +
  theme(panel.background = element_rect(fill = "grey", colour = "grey"), 
        panel.grid.major = element_line(colour = "grey"),
        panel.grid.minor = element_line(colour = "grey")) +
  transition_manual(doy) +
  ggtitle('Day: {current_frame}') +
  coord_quickmap()

animate(biomass_animation, fps = 100)
anim_save("high_light_stlew.gif", animation = biomass_animation, 
          path = "regional_runs_inputs/results/", fps = 100)
```

# Decreased Stomatal Slope Regional Runs

## Read in input files

This set of runs uses the same parameters as above for the high light treatment, except in `config.xml` the stomatal slope input value is changed from `r config$pft$photoParms$b1` to `r config_ss$pft$photoParms$b1`. 

```{r}
config_ss <- read.biocro.config("regional_runs_inputs/config_ss.xml")
```

## Run BioCro on each location

```{r}
dir.create("regional_runs_inputs/results/high_light_ss_stlew")

regional_run_results_ss <- c()
for(point in 1:nrow(latlon)){
  biocro_met_path <- paste0("regional_runs_inputs/biocro_met_stlew/stlew-", 
                            latlon$lat[point], "-", latlon$lon[point])
  regional_run_result_ss <- run.biocro(latlon$lat[point], latlon$lon[point],
                               metpath = biocro_met_path,
                               soil.nc = soil_nc,
                               config = config_ss)
  regional_run_result_ss_daily <- regional_run_result_ss$daily
  write.csv(regional_run_result_ss_daily, paste0("regional_runs_inputs/results/high_light_ss_stlew/daily-", 
                                         latlon$lat[point], "-", latlon$lon[point], ".csv"))
  regional_run_result_ss_daily$lat <- latlon$lat[point]
  regional_run_result_ss_daily$lon <- latlon$lon[point]
  regional_run_results_ss <- rbind(regional_run_results_ss, regional_run_result_ss_daily)
  print(point)
}

write.csv(regional_run_results_ss, 
          "regional_runs_inputs/results/high_light_ss_stlew_results.csv")
```

## Plot estimated biomass

```{r}
regional_run_results_ss <- read.csv("regional_runs_inputs/results/high_light_ss_stlew_results.csv")
regional_run_results_ss <- regional_run_results_ss %>% 
  mutate(date = as.Date(doy, "2009-12-31"), 
         latlon = paste0(lat, lon), 
         total_biomass = as.numeric(Stem + Leaf + Root + Rhizome + Grain))

ggplot(regional_run_results_ss, aes(x = date, y = total_biomass, group = latlon, color = latlon)) +
  geom_line() +
  theme(legend.position = "none")
```

```{r}
summer_day_plot_ss <- ggplot() +
  geom_polygon(data = overall_map, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = filter(regional_run_results_ss, doy == 200), aes(x = lon, y = lat, fill = total_biomass)) +
  coord_quickmap() +
  ggtitle("Day 200")

winter_day_plot_ss <- ggplot() +
  geom_polygon(data = overall_map, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = filter(regional_run_results_ss, doy == 350), aes(x = lon, y = lat, fill = total_biomass)) +
  coord_quickmap() +
  ggtitle("Day 350")

cowplot::plot_grid(summer_day_plot_ss, winter_day_plot_ss, nrow = 1)
```

```{r}
# ggplot() +
#   geom_polygon(data = ecoregions_df_chiruss, aes(long, lat, group = group, col = ECO_NAME)) +
#   geom_polygon(data = ecoregions_background, aes(x = long, y = lat, group = group), fill = NA, color = "black") +
#   theme(legend.position = "none") +
#   geom_raster(data = filter(regional_run_results_ss, doy == 200), aes(x = lon, y = lat, fill = total_biomass)) +
#   coord_cartesian(xlim = c(mean(regional_run_results_ss$lon) - 20, mean(regional_run_results_ss$lon) + 20),
#                   ylim = c(min(regional_run_results_ss$lat) - 5, max(regional_run_results_ss$lat) + 5)) +
#   theme(legend.position = "none")
```

```{r}
biomass_animation_ss <- ggplot() +
  geom_polygon(data = gif_background, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = regional_run_results_ss, aes(x = lon, y = lat, fill = total_biomass)) +
  geom_point(data = city_coords, aes(x = lon, y = lat)) +
  scale_fill_gradient2(low = "yellow", mid = "yellowgreen", high = "darkgreen", 
                       midpoint = 10, 
                       breaks = seq(-100, 100, 4), 
                       limits = c(0, 20)) +
  theme(panel.background = element_rect(fill = "grey", colour = "grey"), 
        panel.grid.major = element_line(colour = "grey"),
        panel.grid.minor = element_line(colour = "grey")) +
  transition_manual(doy) +
  ggtitle('Day: {current_frame}') +
  coord_quickmap()

animate(biomass_animation_ss, fps = 100)
anim_save("high_light_ss_stlew.gif", animation = biomass_animation_ss, 
          path = "regional_runs_inputs/results/", fps = 100)
```

# Comparing Regional Runs

Combining data from high light and decreased stomatal slope regional runs.

```{r}
rr <- regional_run_results %>% 
  select(date, lat, lon, latlon, total_biomass)
rr_ss <- regional_run_results_ss %>% 
  select(date, latlon, total_biomass) %>% 
  rename(total_biomass_ss = total_biomass)
comb <- left_join(rr, rr_ss, by = c("date", "latlon")) %>% 
  mutate(total_biomass_diff = total_biomass_ss - total_biomass)
```

Time series showing mean difference in biomass for locations, with variation in daily values shown.

```{r}
comb_by_time <- comb %>% 
  group_by(date) %>% 
  summarise(mean_diff = mean(total_biomass_diff, na.rm = TRUE), 
            sd_diff = sd(total_biomass_diff, na.rm = TRUE))

ggplot(comb_by_time, aes(x = date, y = mean_diff)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = mean_diff - sd_diff, ymax = mean_diff + sd_diff), alpha = 0.3)
```

Spatial plot showing mean difference in biomass for days. 

```{r}
comb_by_space <- comb %>% 
  group_by(latlon, lat, lon) %>% 
  summarise(mean_diff = mean(total_biomass_diff, na.rm = TRUE)) 

ggplot() +
  geom_polygon(data = overall_map, aes(x = long, y = lat, group = group), 
               fill = "white", color = "black") +
  geom_raster(data = comb_by_space, aes(x = lon, y = lat, fill = mean_diff))
```
