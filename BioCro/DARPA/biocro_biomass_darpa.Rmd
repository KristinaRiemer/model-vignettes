---
title: "How to Do Biomass Partitioning on DARPA Data Using BioCro Model"
author: "Kristina Riemer, University of Arizona"
output: github_document
urlcolor: blue
---

For biomass partitioning using [`OpBioGro`](https://github.com/ebimodeling/biocro/blob/master/R/OpBioGro.R). 

### Weather data

From CLM file `clm_version.nc` to a dataframe with hourly rows and five weather variables. 

BioCro var name   | BioCro var unit | CLM var name | CLM var unit    
----------------- | --------------- | ------------ | ------------    
solarR            | umol/m2/s       | FSDS         | W/m2            
DailyTemp.C       | C               | TBOT         | K               
RH                | 0-1             | RH           | %               
WindSpeed         | m/s             | WIND         | m/s                
precip            | mm (mm/h)       | PRECTmms     | mm/s                

Need to downscale all weather data from every three hours to hourly, and also convert some units, as shown in the table above. 

Specific downscaling and conversion for each variable: 

1. Radiation: used spline interpolation from PEcAn (https://github.com/PecanProject/pecan/blob/develop/modules/data.atmosphere/R/temporal.downscaling.R#L48), converted from W/m2 (1 W/m2 = 4.6 umol/m2/s)
2. Temperature: made three copies of each value, and converted from K to C
3. Humidity: made three copies of each value, and converted from percentage to 0-1 scale
4. Wind: no wind, filled in with zeroes
5. Precipitation: filled in with zeroes, didn't convert single daily value

Read in data and libraries: 
```{r}
library(ncdf4)
library(dplyr)
library(lubridate)
clm_met <- nc_open("clm_version.nc")
```

Do variable conversions and downscaling: 
```{r}
DailyTemp.C <- rep(ncvar_get(clm_met, "TBOT") - 273.15, each = 3)
RH <- rep(ncvar_get(clm_met, "RH") / 100, each = 3)
WindSpeed <- rep(ncvar_get(clm_met, "WIND"), each = 3)
PRECTmms <- ncvar_get(clm_met, "PRECTmms")
precip <- rep(c(unique(PRECTmms)[1], rep(0, 23)), 365)

FSDS <- ncvar_get(clm_met, "FSDS") * 4.6
FSDS_df <- data.table::data.table(data.frame(
  date = seq(as.POSIXct(strptime("2000-01-01 00:00:00", "%Y-%m-%d %H:%M:%S")), 
             as.POSIXct(strptime("2000-12-30 21:00:00", "%Y-%m-%d %H:%M:%S")), 
             3*60*60), 
  year = rep(2000, 2920), 
  doy = rep(1:365, each = 8), 
  hour = rep(seq(0, 21, by = 3), 365), 
  FSDS = FSDS) %>% 
    mutate(day = day(date), 
           month = month(date)))

output.dt <- 1
hrscale <- 1
downscaled.result <- list()

new.date <- FSDS_df[,list(hour = 0:(23 / output.dt) / output.dt),
                        by = c("year", "month", "day", "doy")]
new.date$date <- new.date[,list(date = lubridate::ymd_h(paste(year, month, day, hour)))]

f <- stats::splinefun(as.double(FSDS_df$date), (FSDS_df$FSDS / hrscale), method = "monoH.FC")
downscaled.result$FSDS <- f(as.double(new.date$date))
downscaled.result$FSDS[downscaled.result$FSDS < 0] <- 0
downscaled.result <- cbind(new.date, data.table::as.data.table(downscaled.result))
```

Assemble final weather dataframe: 
```{r}
time <- data.frame(year = rep(2019, 8760), 
                   doy = rep(1:365, each = 24), 
                   hour = rep(seq(0, 23), 365))
OpBioGro_weather <- data.frame(time, solarR = downscaled.result$FSDS, DailyTemp.C, RH, WindSpeed, precip)
```

Several different visualizations to check these weather data are created. 
```{r}
skimr::skim(OpBioGro_weather)
```

```{r}
tabplot::tableplot(OpBioGro_weather, sortCol = "doy")
```

```{r, fig.width=10}
t <- OpBioGro_weather %>% 
  mutate(date = new.date$date) %>% 
  dplyr::select(solarR:date) %>% 
  tidyr::pivot_longer(cols = solarR:precip)
t

library(ggplot2)
ggplot(t, aes(date, value)) +
  geom_line(size = 0.1) + 
  facet_wrap(~name, ncol = 1, scales = 'free_y')

ggplot(t %>% filter(month(date) ==1), aes(date, value)) +
  geom_line(size = 0.1) + 
  facet_wrap(~name, ncol = 1, scales = 'free_y')
```
### Biomass data

Plants all started to grow at same time (Jan 3, 2019). Plants harvested on six different dates, from Jan 15 - Feb 19. The plants were grown at three different temperatures, and there were three genotypes. Initially only using data for the middle temperature (31*C) and the first replicate from that. 

Biomass measurements are estimates from pixel sizes for images taken of plants. 
```{r}
library(BioCro)

biomass_data_all <- read.csv("biomass_setaria_me034_gehan.csv") %>% 
  filter(genotype == "ME034V-1", 
         temperature_celsius == 31) %>% 
  group_by(biomas_harvested) %>% 
  slice(1) %>% 
  ungroup()

skimr::skim(biomass_data_all %>% select(temperature_celsius, panicle.FW.g.:roots.DW..mg.))
```

Plot of first replicate 31*C dry weights for stem, leaf, panicle/grain, and roots across six time points when biomass was measured. 
```{r}
s <- biomass_data_all %>% 
  mutate(date = lubridate::mdy(biomas_harvested)) %>% 
  select(temperature_celsius, date, contains('DW.')) %>% 
  tidyr::pivot_longer(panicle.DW.mg.:roots.DW..mg.)

ggplot(s, aes(date, value, color = name)) +
  geom_line() 
```

Added how many days each plant was grown before harvested to the biomass dataframe. Then calculated thermal times for weather data using `BioGro`, using only the thermal times for the days of harvest. 
```{r}
biomass_data_single <- biomass_data_all %>% 
  mutate(days_grown = as.integer(as.Date(as.character(biomas_harvested),format="%m/%d/%Y") - as.Date(as.character(seeds_in_germination),format="%m/%d/%Y")))

weather_only_run <- BioGro(OpBioGro_weather, day1 = 1, dayn = 365)
weather_only_run_df <- as.data.frame(unclass(weather_only_run)[1:11]) %>%
  select(Hour, DayofYear, ThermalT) %>% 
  filter(Hour == 0, 
         DayofYear %in% biomass_data_single$days_grown) %>% 
  mutate(days_grown = DayofYear)
```

Combined biomass data for stem, leaf, panicle/grain, and root from data with corresponding calculated thermal time. Added in values of zero for rhizome at each thermal time point. Lastly estimated LAI using leaf biomass measurements with SLA. All values are plotted against thermal time. 
```{r}
SLA_mg <- 80 / 1000000
OpBioGro_biomass <- left_join(biomass_data_single, weather_only_run_df, by = "days_grown") %>% 
  select(ThermalT, Stem = stemDW.mg., Leaf = leaf.DW.mg., Root = roots.DW..mg., Grain = panicle.DW.mg.) %>% 
  mutate(Rhizome = rep(0, 6), 
         LAI = SLA_mg * Leaf)
OpBioGro_biomass <- data.frame(OpBioGro_biomass) %>% 
  arrange(ThermalT)

OpBioGro_biomass_plot <- OpBioGro_biomass %>% 
  tidyr::pivot_longer(Stem:LAI)
ggplot(OpBioGro_biomass_plot %>% filter(name != "LAI"), aes(x = ThermalT, y = value, color = name)) +
  geom_line() +
  ylab("Dry Weight (mg)")
ggplot(OpBioGro_biomass_plot %>% filter(name == "LAI"), aes(x = ThermalT, y = value)) +
  geom_line() +
  ylab("Leaf Area Index (units?)")
```

### Estimate coefficients

Updating phenological parameters that will go into partitioning estimates. This includes setting the thermal times to correspond to the dates of biomass measurements, and setting all rhizome growth values to zero so that this stays zero. Otherwise using default values. 
```{r}
p <- phenoParms() 
p[1:6] <- OpBioGro_biomass$ThermalT#c(400, 600, 800, 1000, 1200, 1500)
p['kRhizome1'] <- 0
p['kRhizome2'] <- 0
p['kRhizome3'] <- 0
p['kRhizome4'] <- 0
p['kRhizome5'] <- 0
p['kRhizome6'] <- 0
```

Generate initial guesses at coefficients using these updated phenological parameters and the measured biomass values using `idbp`. These values than are validated using `valid_dbp`. The eighth value had to be changed manually to pass this validation step because it was initially shown as `Inf`. 
```{r}
initial_coefs <- idbp(OpBioGro_biomass, phenoControl = p)
initial_coefs[8] <- -0.000000000000001
valid_dbp(initial_coefs)
```

The previously generated weather data, along with those initial estimated biomass coefficients and the biomass measurements, are passed to the function that optimizes for biomass partitioning coefficients. This is optimized for all six phenological stages because of the `phen` argument. 
```{r}
# defaults day1 = 90; dayn = 330
biomass_coefs <- constrOpBioGro(phen = 0, 
                                WetDat = OpBioGro_weather,
                                data = OpBioGro_biomass, 
                                iCoef = initial_coefs, 
                                iRhizome = 0, 
                                phenoControl = p)
biomass_coefs
```

