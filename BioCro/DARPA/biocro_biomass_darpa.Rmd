---
title: "How to Do Biomass Partitioning on DARPA Data Using BioCro Model"
author: "Kristina Riemer, University of Arizona"
output: github_document
urlcolor: blue
---

For biomass partitioning using [`OpBioGro`](https://github.com/ebimodeling/biocro/blob/master/R/OpBioGro.R). 

### Weather data

From CLM file `clm_version.nc` to a dataframe with hourly rows and five weather variables. 

BioCro var name   | BioCro var unit | CLM var name | CLM var unit    
----------------- | --------------- | ------------ | ------------    
solarR            | umol/m2/s       | FSDS         | W/m2            
DailyTemp.C       | C               | TBOT         | K               
RH                | 0-1             | RH           | %               
WindSpeed         | m/s             | WIND         | m/s                
precip            | mm (mm/h)       | PRECTmms     | mm/s                

Need to downscale all weather data from every three hours to hourly, and also convert some units, as shown in the table above. 

Specific downscaling and conversion for each variable: 

1. Radiation: used spline interpolation from PEcAn (https://github.com/PecanProject/pecan/blob/develop/modules/data.atmosphere/R/temporal.downscaling.R#L48), converted from W/m2 (1 W/m2 = 4.6 umol/m2/s)
2. Temperature: made three copies of each value, and converted from K to C
3. Humidity: made three copies of each value, and converted from percentage to 0-1 scale
4. Wind: no wind, filled in with zeroes
5. Precipitation: filled in with zeroes, didn't convert single daily value

Read in data and libraries: 
```{r}
library(ncdf4)
library(dplyr)
library(lubridate)
clm_met <- nc_open("clm_version.nc")
```

Do variable conversions and downscaling: 
```{r}
DailyTemp.C <- rep(ncvar_get(clm_met, "TBOT") - 273.15, each = 3)
RH <- rep(ncvar_get(clm_met, "RH") / 100, each = 3)
WindSpeed <- rep(ncvar_get(clm_met, "WIND"), each = 3)
PRECTmms <- ncvar_get(clm_met, "PRECTmms")
precip <- rep(c(unique(PRECTmms)[1], rep(0, 23)), 365)

FSDS <- ncvar_get(clm_met, "FSDS") * 4.6
FSDS_df <- data.table::data.table(data.frame(
  date = seq(as.POSIXct(strptime("2000-01-01 00:00:00", "%Y-%m-%d %H:%M:%S")), 
             as.POSIXct(strptime("2000-12-30 21:00:00", "%Y-%m-%d %H:%M:%S")), 
             3*60*60), 
  year = rep(2000, 2920), 
  doy = rep(1:365, each = 8), 
  hour = rep(seq(0, 21, by = 3), 365), 
  FSDS = FSDS) %>% 
    mutate(day = day(date), 
           month = month(date)))

output.dt <- 1
hrscale <- 1
downscaled.result <- list()

new.date <- FSDS_df[,list(hour = 0:(23 / output.dt) / output.dt),
                        by = c("year", "month", "day", "doy")]
new.date$date <- new.date[,list(date = lubridate::ymd_h(paste(year, month, day, hour)))]

f <- stats::splinefun(as.double(FSDS_df$date), (FSDS_df$FSDS / hrscale), method = "monoH.FC")
downscaled.result$FSDS <- f(as.double(new.date$date))
downscaled.result$FSDS[downscaled.result$FSDS < 0] <- 0
downscaled.result <- cbind(new.date, data.table::as.data.table(downscaled.result))
```

Assemble final weather dataframe: 
```{r}
time <- data.frame(year = rep(2019, 8760), 
                   doy = rep(1:365, each = 24), 
                   hour = rep(seq(0, 23), 365))
OpBioGro_weather <- data.frame(time, solarR = downscaled.result$FSDS, DailyTemp.C, RH, WindSpeed, precip)
```

Summarize Weather

```{r}
skimr::skim(OpBioGro_weather)
```

```{r}
tabplot::tableplot(OpBioGro_weather)
```

```{r, fig.width=10}
t <- OpBioGro_weather %>% 
  mutate(date = new.date$date) %>% 
  dplyr::select(solarR:date) %>% 
  tidyr::pivot_longer(cols = solarR:precip)
t

library(ggplot2)
ggplot(t, aes(date, value)) +
  geom_line(size = 0.1) + 
  facet_wrap(~name, ncol = 1, scales = 'free_y')

ggplot(t %>% filter(month(date) ==1), aes(date, value)) +
  geom_line(size = 0.1) + 
  facet_wrap(~name, ncol = 1, scales = 'free_y')
```
### Biomass data

Plants all started to grow at same time (Jan 3, 2019). Plants harvested on six different dates, from Jan 15 - Feb 19. The plants were grown at three different temperatures, and there were three genotypes. Initially only using data for the middle temperature (31*C) and the first replicate from that. 

Got biomass data for stem, leaf, and root from data and used zeroes for rhizome and grain. Calculated thermal times for weather data using `BioGro`, then used the ones for the same day of year as the plants were grown before harvested. Last, used an estimated SLA combined with leaf mass to get LAI values. 

```{r}
library(BioCro)

biomass_data_all <- read.csv("biomass_setaria_me034_gehan.csv") %>% 
  filter(genotype == "ME034V-1", 
         temperature_celsius == 31) %>% 
  group_by(biomas_harvested) %>% 
  slice(1) %>% 
  ungroup()

skimr::skim(biomass_data_all %>% select(temperature_celsius, panicle.FW.g.:roots.DW..mg.))
```

```{r}
s <- biomass_data_all %>% 
  mutate(date = lubridate::mdy(biomas_harvested)) %>% 
  select(temperature_celsius, date, contains('.DW.')) %>% 
  tidyr::pivot_longer(panicle.DW.mg.:roots.DW..mg.)

ggplot(s, aes(date, value, color = name)) +
  geom_line() 
```


```{r}
biomass_data_single <- biomass_data_all %>% 
  mutate(days_grown = as.integer(as.Date(as.character(biomas_harvested),format="%m/%d/%Y") - as.Date(as.character(seeds_in_germination),format="%m/%d/%Y")))

weather_only_run <- BioGro(OpBioGro_weather, day1 = 1, dayn = 365)
weather_only_run_df <- as.data.frame(unclass(weather_only_run)[1:11]) %>%
  select(Hour, DayofYear, ThermalT) %>% 
  filter(Hour == 0, 
         DayofYear %in% biomass_data_single$days_grown) %>% 
  mutate(days_grown = DayofYear)

SLA_mg <- 80 / 1000000
OpBioGro_biomass <- left_join(biomass_data_single, weather_only_run_df, by = "days_grown") %>% 
  select(ThermalT, Stem = stemDW.mg., Leaf = leaf.DW.mg., Root = roots.DW..mg., Grain = panicle.DW.mg.) %>% 
  mutate(Rhizome = rep(0, 6), 
         LAI = SLA_mg * Leaf)
OpBioGro_biomass <- data.frame(OpBioGro_biomass) %>% 
  arrange(ThermalT)
```

### Estimate coefficients

```{r}
coef_estimates <- valid_dbp(idbp(OpBioGro_biomass))

z <- OpBioGro_biomass
library(ggplot2)
library(tidyverse)
ggplot(z %>% tidyr::pivot_longer(Stem:LAI), aes(ThermalT, value, color = name)) +
  geom_line() 
# z[5,2:4] <- c(776, 318, 222)
# z[6,2:4] <- c(800, 368, 252)
# ggplot(z %>% tidyr::pivot_longer(Stem:LAI), aes(ThermalT, value, color = name)) +
#   geom_line() 

zz<-rbind(rep(0,6), z)

p <- phenoParms() 
p[1:6] <- z$ThermalT#c(400, 600, 800, 1000, 1200, 1500)
p['kRhizome1'] <- 0
p['kRhizome2'] <- 0
p['kRhizome3'] <- 0
p['kRhizome4'] <- 0
p['kRhizome5'] <- 0
p['kRhizome6'] <- 0

x <- idbp(z, phenoControl = p)
x[8] <- 0
valid_dbp(x)
biomass_coefs <- OpBioGro(phen = 0, WetDat = OpBioGro_weather, data = OpBioGro_biomass, iCoef = x)
```

