---
title: "Comparison of Gs modeling with full and partial Licor data"
author: "Jessica Guo, Tonantzin Tarin"
output: github_document
urlcolor: blue
---

Load necessary packages and functions. 
```{r}
library(ggplot2)
source("R/Gs.R")
source("R/Gs_all.R")
```


Stomatal parameters are important to estimate for crop and ecosystem models (e.g., BioCro, ED2), but there is lack of certainty on the best sets of data to include for stomatal parameter estimation. Two prominent methods have been identified: 1) survey measurements of gas exchange under ambient environmental conditions (Lin et al. 2015) and 2) controlled measurements across varying CO2 and light conditions (Ball et al. 1987, Wolz et al. 2017). 

Given that the DARPA-Sentinel project primarily grows Setaria genotypes in controlled chamber conditions, gas exchange data have been AQ and ACi curves. However, the previously designed Gs.R function only includes a narrow range of CO2 and light conditions, which makes slope and intercept estimation unstable and occasionally negative. Furthermore, Gs.R contains an additional cleaning step that may or may not be fully justifiable. 

Therefore, this script will run Gs_all.R, a version of stomatal parameter estimation that uses the entire ACi and AQ curve, and compare the results between the two versions. 

Read in experiment metadata. 
```{r}
expDF <- read.csv("cleaned_data/experiments.csv",
                  colClasses = c("character", "numeric", rep("character",2), rep("numeric",2)))
```

Run the Gs_all.R function on both the ACi and AQ data to obtain the stomatal sensitivity (g1BB & g1M) and cuticular conductance (g0BB & g0M, mol H2O m^-2 s^-1) across the plant replicates. Here, the data from both types of curves are restricted to 390 ppm < CO2 < 410 ppm and PAR > 1200 umol photons m^-2 s^-1 and fit to the Ball-Berry (1987) and Medlyn (2011) models using the package 'plantecophys'. 
```{r}
ID <- unique(expDF$ID)
for(i in 1:length(ID)){
  Gs_all(fileID = ID[i])
  print(paste0(ID[i], " completed"))
}
```

Compare stomatal parameters for Gs and Gs_all
```{r}
# Declare empty dataframe
params <- data.frame()

# Add Gs parameters
gs <- list.files("outputs/stomatal", pattern = "csv")
for(i in 1:length(gs)){
  temp <- read.csv(paste0("outputs/stomatal/", gs[i]),
                   colClasses = c(rep("character", 3), rep("numeric",3), "character"))
  params <- rbind.data.frame(params, temp)
}

# Add Gs_all parameters
gs_all <- list.files("outputs/stomatal/all", pattern = "csv")
for(i in 1:length(gs_all)){
  temp <- read.csv(paste0("outputs/stomatal/all/", gs_all[i]),
                   colClasses = c(rep("character", 3), rep("numeric",3), "character"))
  params <- rbind.data.frame(params, temp)
}

# Add column identifying which function used
params$method <- c(rep("Gs", length(gs)*4), 
                   rep("Gs_all", length(gs_all)*4))

# Combine parameters with experiment metadata
gs_params <- left_join(params, expDF, by = "ID")
```

Create plots to compare each trait (facet) between experiments
```{r}
ggplot(gs_params, aes(x = ID, y = Value, col = method))+
  geom_pointrange(aes(ymin = Value - SE, ymax = Value + SE), alpha = 0.75)+
  geom_hline(yintercept = 0, lwd = 1)+
  facet_wrap( ~ trait, scale = "free_y")+
  theme_bw(base_size = 14)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```
